<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VeltraWave - Buy Data</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* Reset and Base Styles */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Outfit', sans-serif;
  -webkit-tap-highlight-color: transparent;
}

:root {
  --primary: #2D7FF9;
  --primary-light: #5A9DFF;
  --primary-dark: #0D5ED6;
  --secondary: #8C52FF;
  --accent: #FF5E8A;
  --background: #0A0F1E;
  --card-bg: rgba(255, 255, 255, 0.08);
  --surface: rgba(255, 255, 255, 0.12);
  --text: #FFFFFF;
  --text-secondary: rgba(255, 255, 255, 0.7);
  --success: #00E1A0;
  --warning: #FFB547;
  --error: #FF5E7D;
  --mtn-yellow: #FFCC00;
  --airtel-red: #FF0000;
  --glo-green: #00AB4E;
  --etisalat-green: #006F53;
}

body {
  background-color: var(--background);
  color: var(--text);
  min-height: 100vh;
  position: relative;
  padding-bottom: 80px; /* Space for bottom nav */
}

/* Liquid Blob Background */
.liquid-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: -1;
  overflow: hidden;
}

.liquid-blob {
  position: absolute;
  border-radius: 50%;
  filter: blur(60px);
  opacity: 0.15;
  animation: float 20s infinite ease-in-out;
}

.blob-1 {
  width: 600px;
  height: 600px;
  background: var(--primary);
  top: -200px;
  right: -100px;
  animation-delay: 0s;
}

.blob-2 {
  width: 500px;
  height: 500px;
  background: var(--secondary);
  bottom: -150px;
  left: -100px;
  animation-delay: -5s;
}

.blob-3 {
  width: 300px;
  height: 300px;
  background: var(--accent);
  top: 40%;
  right: 20%;
  animation-delay: -10s;
}

@keyframes float {
  0%, 100% {
      transform: translate(0, 0) scale(1);
  }
  25% {
      transform: translate(5%, 5%) scale(1.05);
  }
  50% {
      transform: translate(0, 10%) scale(0.95);
  }
  75% {
      transform: translate(-5%, 5%) scale(1.05);
  }
}

/* Data Page Styles */
.data-container {
  max-width: 500px;
  margin: 0 auto;
  padding: 0 1rem;
  padding-bottom: 80px;
  position: relative;
  z-index: 1;
}

/* Header Styles */
.page-header {
  display: flex;
  align-items: center;
  padding: 1.5rem 0;
  margin-bottom: 1.5rem;
}

.back-button {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--surface);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  border: none;
  color: var(--text);
  margin-right: 1rem;
}

.back-button:hover {
  background: rgba(255, 255, 255, 0.2);
}

.page-title {
  font-size: 1.5rem;
  font-weight: 600;
}

/* Balance Display */
.balance-display {
  background: rgba(45, 127, 249, 0.1);
  border-radius: 12px;
  padding: 12px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.balance-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.balance-value {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--success);
}

/* Mode Selection Tabs */
.mode-tabs-container {
  background: rgba(45, 127, 249, 0.1);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.mode-tabs-title {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 12px;
}

.mode-tabs {
  display: flex;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 10px;
  padding: 4px;
  position: relative;
}

.mode-tab {
  flex: 1;
  text-align: center;
  padding: 10px 0;
  cursor: pointer;
  position: relative;
  z-index: 2;
  transition: color 0.3s ease;
  border-radius: 8px;
  font-weight: 500;
}

.mode-tab.active {
  color: var(--background);
}

.mode-tab-indicator {
  position: absolute;
  height: calc(100% - 8px);
  width: calc(50% - 4px);
  background: var(--primary);
  border-radius: 6px;
  top: 4px;
  left: 4px;
  transition: transform 0.3s ease;
}

.mode-tab-indicator.manual {
  transform: translateX(100%);
}

/* Network Selection */
.network-slider-container {
  margin-bottom: 2rem;
  position: relative;
  display: none;
}

.network-slider-container.show {
  display: block;
}

.slider-indicators {
  display: flex;
  justify-content: center;
  margin-bottom: 1rem;
}

.indicator {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: rgba(255, 255, 255, 0.2);
  margin: 0 4px;
  transition: all 0.3s ease;
  cursor: pointer;
}

.indicator.active {
  background-color: var(--primary);
  width: 20px;
  border-radius: 4px;
}

.network-slider {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  -ms-overflow-style: none;
  padding: 0.5rem 0;
}

.network-slider::-webkit-scrollbar {
  display: none;
}

.network-option {
  flex: 0 0 100%;
  min-width: 100%;
  scroll-snap-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 2rem;
  background: var(--card-bg);
  border-radius: 1.5rem;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
  cursor: pointer;
  user-select: none;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.network-option:hover {
  transform: translateY(-5px);
  background: rgba(255, 255, 255, 0.12);
}

.network-option.selected {
  border-color: var(--primary);
  background: rgba(45, 127, 249, 0.1);
}

.network-image {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 1rem;
  position: relative;
  overflow: hidden;
}

.network-option.mtn .network-image {
  background-color: var(--mtn-yellow);
}

.network-option.glo .network-image {
  background-color: var(--glo-green);
}

.network-option.airtel .network-image {
  background-color: var(--airtel-red);
}

.network-option.mobile9 .network-image {
  background-color: var(--etisalat-green);
}

.network-logo {
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 2rem;
}

.network-option.mtn .network-logo {
  color: black;
}

.network-name {
  font-weight: 600;
  font-size: 1.2rem;
  color: var(--text);
}

/* Form Styles */
.form-container {
  background: var(--card-bg);
  border-radius: 1.5rem;
  padding: 1.5rem;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
  margin-bottom: 1.5rem;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.05);
}

.form-group {
  margin-bottom: 1.5rem;
}

.form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: var(--text-secondary);
}

.input-wrapper {
  position: relative;
}

.input-icon {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-secondary);
}

.form-input, .form-select {
  width: 100%;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 0.75rem;
  color: var(--text);
  padding: 0.75rem 1rem 0.75rem 2.5rem;
  font-size: 1rem;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.form-input:focus, .form-select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(45, 127, 249, 0.2);
}

.form-input.network-display {
  background-color: rgba(255, 255, 255, 0.05);
  font-weight: 600;
}

.form-select {
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 1rem center;
  background-size: 1rem;
}

.form-select option {
  background: #1A2035;
  color: white;
}

.form-select:disabled, .form-input:disabled {
  background-color: rgba(255, 255, 255, 0.03);
  cursor: not-allowed;
  opacity: 0.7;
}

.form-input::placeholder {
  color: rgba(255, 255, 255, 0.4);
}

.btn {
  display: inline-block;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 0.75rem;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(45, 127, 249, 0.3);
}

.btn-primary:active {
  transform: scale(0.98);
}

.btn-primary:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-block {
  display: block;
  width: 100%;
}

.btn-danger {
  background: linear-gradient(135deg, var(--error), #b91c1c);
  color: white;
}

.btn-warning {
  background: linear-gradient(135deg, var(--warning), #d97706);
  color: white;
}

.btn-danger:hover, .btn-warning:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
}

/* Auto-detect Section */
.auto-detect-section {
  display: none;
  margin-bottom: 1.5rem;
}

.auto-detect-section.show {
  display: block;
}

.auto-detect-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.auto-detect-title {
  font-weight: 600;
  font-size: 1rem;
}

.auto-detect-status {
  font-size: 0.9rem;
  color: var(--text-secondary);
}

.auto-detect-status.detecting {
  color: var(--warning);
}

.auto-detect-status.success {
  color: var(--success);
}

.auto-detect-status.error {
  color: var(--error);
}

.auto-detect-button {
  background: rgba(45, 127, 249, 0.2);
  border: none;
  border-radius: 0.75rem;
  padding: 0.75rem 1rem;
  color: var(--text);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
}

.auto-detect-button:hover {
  background: rgba(45, 127, 249, 0.3);
}

.auto-detect-button i {
  margin-right: 0.5rem;
}

.auto-detect-button.detecting {
  background: rgba(255, 181, 71, 0.2);
  cursor: not-allowed;
}

.auto-detect-button.success {
  background: rgba(0, 225, 160, 0.2);
}

/* MTN Special Data Plans Section */
.mtn-special-plans {
  background: linear-gradient(135deg, rgba(255, 204, 0, 0.15) 0%, rgba(255, 204, 0, 0.3) 100%);
  border-radius: 16px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255, 204, 0, 0.3);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  display: none; /* Hidden by default, shown when MTN is selected */
}

.mtn-special-plans.show {
  display: block;
}

.section-shapes {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
  left: 0;
  z-index: 0;
  overflow: hidden;
}

.shape {
  position: absolute;
  opacity: 0.15;
  background-color: var(--mtn-yellow);
}

.shape-circle {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  top: -40px;
  right: -40px;
}

.shape-square {
  width: 60px;
  height: 60px;
  bottom: 20px;
  left: 10%;
  transform: rotate(45deg);
}

.shape-triangle {
  width: 0;
  height: 0;
  border-left: 50px solid transparent;
  border-right: 50px solid transparent;
  border-bottom: 80px solid var(--mtn-yellow);
  bottom: -40px;
  right: 15%;
  opacity: 0.1;
}

.section-content {
  position: relative;
  z-index: 1;
}

.section-title {
  color: var(--mtn-yellow);
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.section-tagline {
  color: var(--mtn-yellow);
  font-size: 0.9rem;
  font-weight: 500;
  margin-bottom: 1rem;
}

.important-notes {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 1rem;
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.important-notes h3 {
  color: var(--mtn-yellow);
  margin-bottom: 0.75rem;
  font-size: 1rem;
}

.important-notes ul {
  list-style-type: none;
  padding: 0;
}

.important-notes li {
  margin-bottom: 0.5rem;
  color: rgba(255, 255, 255, 0.9);
  display: flex;
  align-items: center;
  font-size: 0.85rem;
}

.important-notes li i {
  color: var(--mtn-yellow);
  margin-right: 0.5rem;
  font-size: 0.85rem;
}

/* Manual Data Plans */
.manual-data-section {
  display: none;
  margin-bottom: 1.5rem;
}

.manual-data-section.show {
  display: block;
}

.plan-category {
  margin-bottom: 1.5rem;
}

.category-title {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
  color: var(--primary-light);
}

.category-description {
  font-size: 0.85rem;
  color: var(--text-secondary);
  margin-bottom: 1rem;
}

.plan-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 10px;
}

.plan-card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.plan-card:hover {
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-3px);
}

.plan-card.selected {
  border-color: var(--primary);
  background: rgba(45, 127, 249, 0.1);
}

.plan-data {
  font-size: 1.2rem;
  font-weight: 700;
  margin-bottom: 5px;
}

.plan-validity {
  font-size: 0.8rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.plan-price {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--success);
}

.plan-original-price {
  font-size: 0.8rem;
  color: var(--text-secondary);
  text-decoration: line-through;
  margin-right: 5px;
}

.plan-badge {
  position: absolute;
  top: 0;
  right: 0;
  background: var(--warning);
  color: var(--background);
  font-size: 0.6rem;
  font-weight: 700;
  padding: 3px 6px;
  border-bottom-left-radius: 8px;
}

.plan-badge.hot {
  background: var(--error);
}

.plan-badge.popular {
  background: var(--secondary);
}

.plan-badge.value {
  background: var(--success);
}

/* Request History Section */
.request-history-toggle {
  background: rgba(45, 127, 249, 0.1);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 20px;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.05);
  cursor: pointer;
  transition: all 0.3s ease;
}

.request-history-toggle:hover {
  background: rgba(45, 127, 249, 0.15);
}

.request-history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.request-history-title {
  font-weight: 600;
  font-size: 1rem;
  display: flex;
  align-items: center;
}

.request-history-title i {
  margin-right: 10px;
}

.request-history-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease;
}

.request-history-toggle.open .request-history-content {
  max-height: 500px;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.request-history-toggle .toggle-icon {
  transition: transform 0.3s ease;
}

.request-history-toggle.open .toggle-icon {
  transform: rotate(180deg);
}

.request-tabs {
  display: flex;
  margin-bottom: 15px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.request-tab {
  padding: 8px 15px;
  cursor: pointer;
  color: var(--text-secondary);
  font-size: 0.9rem;
  transition: all 0.3s ease;
  border-bottom: 2px solid transparent;
}

.request-tab.active {
  color: var(--primary);
  border-bottom-color: var(--primary);
}

.request-list {
  max-height: 300px;
  overflow-y: auto;
  padding-right: 5px;
}

.request-list::-webkit-scrollbar {
  width: 5px;
}

.request-list::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
}

.request-list::-webkit-scrollbar-thumb {
  background: rgba(255, 255, 255, 0.2);
  border-radius: 10px;
}

.request-item {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.request-item:hover {
  background: rgba(255, 255, 255, 0.08);
}

.request-item-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}

.request-date {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.request-status {
  font-size: 0.8rem;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 10px;
}

.request-status.pending {
  background: rgba(255, 181, 71, 0.2);
  color: var(--warning);
}

.request-status.completed {
  background: rgba(0, 225, 160, 0.2);
  color: var(--success);
}

.request-status.rejected {
  background: rgba(255, 94, 125, 0.2);
  color: var(--error);
}

.request-details {
  font-size: 0.9rem;
  margin-bottom: 8px;
}

.request-network {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.empty-requests {
  text-align: center;
  padding: 20px;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

/* Bottom Navigation */
.bottom-nav {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: calc(100% - 40px);
  max-width: 500px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 12px;
  display: flex;
  justify-content: space-around;
  border: 1px solid rgba(255, 255, 255, 0.1);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  z-index: 1000;
}

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px 16px;
  border-radius: 16px;
  cursor: pointer;
  position: relative;
  z-index: 2;
  transition: color 0.3s ease;
  text-decoration: none;
  color: var(--text-secondary);
}

.nav-item.active {
  color: var(--primary);
}

.nav-item i {
  font-size: 1.2rem;
  margin-bottom: 4px;
}

.nav-item span {
  font-size: 0.8rem;
  font-weight: 500;
}

/* Toast Notification */
.toast {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  top: 20px;
  padding: 16px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  color: var(--text);
  font-size: 0.9rem;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease-in-out;
  max-width: 90%;
  width: 350px;
  display: flex;
  align-items: center;
  border-left: 4px solid var(--primary);
  opacity: 0;
  visibility: hidden;
}

.toast.show {
  opacity: 1;
  visibility: visible;
}

.toast.success {
  border-left-color: var(--success);
}

.toast.error {
  border-left-color: var(--error);
}

.toast.warning {
  border-left-color: var(--warning);
}

.toast-icon {
  margin-right: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.toast.success .toast-icon {
  color: var(--success);
}

.toast.error .toast-icon {
  color: var(--error);
}

.toast.warning .toast-icon {
  color: var(--warning);
}

/* Custom Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 15, 30, 0.8);
  backdrop-filter: blur(5px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: linear-gradient(135deg, rgba(45, 127, 249, 0.2), rgba(140, 82, 255, 0.2));
  border-radius: 24px;
  padding: 24px;
  max-width: 90%;
  width: 400px;
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.active .modal {
  transform: scale(1);
}

.modal-header {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  color: var(--text);
}

.modal-body {
  margin-bottom: 1.5rem;
  color: var(--text-secondary);
}

.modal-body .summary-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.75rem;
}

.modal-body .summary-label {
  font-weight: 500;
  color: var(--text-secondary);
}

.modal-body .summary-value {
  font-weight: 600;
  color: var(--text);
}

.modal-footer {
  display: flex;
  justify-content: space-between;
  gap: 0.5rem;
}

.modal-footer .btn {
  padding: 0.75rem 1rem;
  flex: 1;
}

.warning-message {
  background: rgba(255, 181, 71, 0.2);
  border-left: 4px solid var(--warning);
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 1rem;
  color: var(--warning);
  font-size: 0.9rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.error-message {
  background: rgba(255, 94, 125, 0.2);
  border-left: 4px solid var(--error);
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 1rem;
  color: var(--error);
  font-size: 0.9rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Loading Spinner */
@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading {
  display: inline-block;
  width: 1rem;
  height: 1rem;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
  margin-right: 0.5rem;
}

/* Responsive Adjustments */
@media (max-width: 480px) {
  .nav-item span {
      font-size: 0.7rem;
  }
  
  .plan-cards {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  }
}

/* Add this CSS for the loading state: */
.loading-requests {
  text-align: center;
  padding: 20px;
  color: var(--text-secondary);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

/* Add this CSS for the pending badge: */
.pending-badge {
  background: var(--warning);
  color: var(--background);
  font-size: 0.7rem;
  font-weight: 700;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 8px;
}
</style>
</head>
<body>
<!-- Liquid Blob Background -->
<div class="liquid-bg">
  <div class="liquid-blob blob-1"></div>
  <div class="liquid-blob blob-2"></div>
  <div class="liquid-blob blob-3"></div>
</div>

</div>
<div class="data-container">
  <div class="page-header">
      <button class="back-button" onclick="window.location.href='index.html'">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M19 12H5"></path>
              <path d="M12 19l-7-7 7-7"></path>
          </svg>
      </button>
      <h1 class="page-title">Buy Data</h1>
  </div>
  
  <!-- Balance Display -->
  <div class="balance-display">
      <div class="balance-label">Wallet Balance</div>
      <div class="balance-value" id="userBalance">Loading...</div>
  </div>
  
  <!-- Mode Selection Tabs -->
  <div class="mode-tabs-container">
      <div class="mode-tabs-title">Purchase Mode</div>
      <div class="mode-tabs">
          <div class="mode-tab automatic active" data-mode="automatic">Automatic</div>
          <div class="mode-tab manual" data-mode="manual">Manual</div>
          <div class="mode-tab-indicator"></div>
      </div>
  </div>
  
  <!-- Network Selection (shown in automatic mode) -->
  <div class="network-slider-container show" id="automaticNetworkSection">
      <div class="slider-indicators" id="sliderIndicators">
          <div class="indicator active" data-index="0"></div>
          <div class="indicator" data-index="1"></div>
          <div class="indicator" data-index="2"></div>
          <div class="indicator" data-index="3"></div>
      </div>
      <div class="network-slider" id="networkSlider">
          <div class="network-option mtn selected" data-network="MTN" data-network-id="1">
              <div class="network-image">
                  <div class="network-logo">M</div>
              </div>
              <div class="network-name">MTN</div>
          </div>
          
          <div class="network-option airtel" data-network="AIRTEL" data-network-id="2">
              <div class="network-image">
                  <div class="network-logo">A</div>
              </div>
              <div class="network-name">Airtel</div>
          </div>
          
          <div class="network-option glo" data-network="GLO" data-network-id="3">
              <div class="network-image">
                  <div class="network-logo">G</div>
              </div>
              <div class="network-name">Glo</div>
          </div>
          
          <div class="network-option mobile9" data-network="9MOBILE" data-network-id="4">
              <div class="network-image">
                  <div class="network-logo">9</div>
              </div>
              <div class="network-name">9mobile</div>
          </div>
      </div>
  </div>
  
  
  <!-- MTN Special Data Plans Section (shown in automatic mode when MTN is selected) -->
  <div class="mtn-special-plans" id="mtnSpecialPlans">
      <div class="section-shapes">
          <div class="shape shape-circle"></div>
          <div class="shape shape-square"></div>
          <div class="shape shape-triangle"></div>
      </div>
      <div class="section-content">
          <h2 class="section-title">VeltraWave Exclusive MTN Special Data Plans</h2>
          <p class="section-tagline">The cheapest MTN data plans available anywhere - exclusively for VeltraWave customers!</p>
          
          <div class="important-notes">
              <h3>Important Notes:</h3>
              <ul>
                  <li><i class="fas fa-check-circle"></i> Premium quality data with full network coverage</li>
                  <li><i class="fas fa-bolt"></i> Fast delivery - data will be delivered within 30 minutes</li>
                  <li><i class="fas fa-layer-group"></i> Large plans (5GB+) may be delivered in multiple transfers</li>
                  <li><i class="fas fa-calendar-alt"></i> Plans expire after validity period (no rollover)</li>
                  <li><i class="fas fa-sim-card"></i> Works on all MTN SIM cards and supports hotspot/tethering</li>
              </ul>
          </div>
      </div>
  </div>
  
  <!-- Manual Data Plans Section (shown when MTN is selected in manual mode) -->
  <div class="manual-data-section" id="manualDataSection">
      <!-- 1-Day Offers -->
      <div class="plan-category">
          <h3 class="category-title">1-Day Offers (24 Hours Validity)</h3>
          <p class="category-description">Best for: Quick browsing, social media, and light streaming.</p>
          <div class="plan-cards" id="oneDayPlans">
              <!-- Plans will be loaded dynamically -->
          </div>
      </div>
      
      <!-- 7-Day Offers -->
      <div class="plan-category">
          <h3 class="category-title">7-Day Offers (1 Week Validity)</h3>
          <p class="category-description">Best for: Heavy users, movie streaming, gaming, and hotspot sharing.</p>
          <div class="plan-cards" id="sevenDayPlans">
              <!-- Plans will be loaded dynamically -->
          </div>
      </div>
      
      <!-- 14-Day Offers -->
      <div class="plan-category">
          <h3 class="category-title">14-Day Offers (2 Weeks Validity)</h3>
          <p class="category-description">Best for: Remote work, gaming, frequent downloads, and social media content creators.</p>
          <div class="plan-cards" id="fourteenDayPlans">
              <!-- Plans will be loaded dynamically -->
          </div>
      </div>
      
      <!-- 30-Day Offers -->
      <div class="plan-category">
          <h3 class="category-title">30-Day Offers (1 Month Validity)</h3>
          <p class="category-description">Best for: Long-term users, multiple device connections, video streaming, and online businesses.</p>
          <div class="plan-cards" id="thirtyDayPlans">
              <!-- Plans will be loaded dynamically -->
          </div>
      </div>
  </div>
  
  <!-- Form Container -->
  <div class="form-container">
      <form id="dataForm">
          <div class="form-group" id="networkDisplayGroup">
              <label for="selectedNetwork" class="form-label">Selected Network</label>
              <div class="input-wrapper">
                  <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 2v2"></path>
                      <path d="M12 20v2"></path>
                      <path d="m4.93 4.93 1.41 1.41"></path>
                      <path d="m17.66 17.66 1.41 1.41"></path>
                      <path d="M2 12h2"></path>
                      <path d="M20 12h2"></path>
                      <path d="m6.34 17.66-1.41 1.41"></path>
                      <path d="m19.07 4.93-1.41 1.41"></path>
                  </svg>
                  <input type="text" id="selectedNetwork" class="form-input network-display" readonly placeholder="Select a network above">
              </div>
          </div>
          
          <!-- Automatic Mode Fields -->
          <div id="automaticModeFields">
              <div class="form-group">
                  <label for="planType" class="form-label">Plan Type</label>
                  <div class="input-wrapper">
                      <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                          <line x1="7" y1="7" x2="7.01" y2="7"></line>
                      </svg>
                      <select id="planType" class="form-select" disabled>
                          <option value="" selected disabled>Select Plan Type</option>
                      </select>
                  </div>
              </div>
              
              <div class="form-group">
                  <label for="dataPlan" class="form-label">Data Plan</label>
                  <div class="input-wrapper">
                      <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                          <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                          <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                          <line x1="12" y1="20" x2="12.01" y2="20"></line>
                      </svg>
                      <select id="dataPlan" class="form-select" disabled>
                          <option value="" selected disabled>Select Data Plan</option>
                      </select>
                  </div>
              </div>
          </div>
          
          <!-- Manual Mode Fields -->
          <div id="manualModeFields" style="display: none;">
              <input type="hidden" id="selectedManualPlan">
              <div class="form-group">
                  <label for="selectedPlanDisplay" class="form-label">Selected Plan</label>
                  <div class="input-wrapper">
                      <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M5 12.55a11 11 0 0 1 14.08 0"></path>
                          <path d="M1.42 9a16 16 0 0 1 21.16 0"></path>
                          <path d="M8.53 16.11a6 6 0 0 1 6.95 0"></path>
                          <line x1="12" y1="20" x2="12.01" y2="20"></line>
                      </svg>
                      <input type="text" id="selectedPlanDisplay" class="form-input" readonly placeholder="Select a plan above">
                  </div>
              </div>
          </div>

          <div class="form-group">
              <label for="phoneNumber" class="form-label">Phone Number</label>
              <div class="input-wrapper">
                  <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                  </svg>
                  <input type="text" id="phoneNumber" class="form-input" placeholder="Enter 11-digit phone number" maxlength="11">
              </div>
          </div>

          <button type="submit" id="submitButton" class="btn btn-primary btn-block" disabled>
              <span id="buttonText">Buy Now</span>
          </button>
      </form>
  </div>
  
  <!-- Request History Section -->
  <div class="request-history-toggle" id="requestHistoryToggle">
      <div class="request-history-header">
          <div class="request-history-title">
              <i class="fas fa-history"></i>
              <span>Request History</span>
          </div>
          <i class="fas fa-chevron-down toggle-icon"></i>
      </div>
      <div class="request-history-content">
          <div class="request-tabs">
              <div class="request-tab active" data-status="all">All</div>
              <div class="request-tab" data-status="pending">Pending</div>
              <div class="request-tab" data-status="completed">Completed</div>
              <div class="request-tab" data-status="rejected">Rejected</div>
          </div>
          <div class="request-list" id="requestList">
              <!-- Requests will be loaded dynamically -->
              <div class="empty-requests">No requests found</div>
          </div>
      </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast">
  <div class="toast-icon" id="toastIcon"></div>
  <div id="toastMessage"></div>
</div>

<!-- Custom Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
      <div class="modal-header">Confirm Purchase</div>
      <div class="modal-body" id="modalBody">
          <!-- Purchase details will be inserted here -->
      </div>
      <div class="modal-footer">
          <button class="btn btn-primary" id="confirmPurchase">Confirm</button>
          <button class="btn btn-danger" id="cancelPurchase">Cancel</button>
      </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // API credentials
  const ACCESS_TOKEN = "3cfedeade5a3a75342ce13245ac4de9e9b3ca0aaf86a05a5aa1447c12d7d";
  
  // Firebase Configuration
  const firebaseConfig = {
      apiKey: "AIzaSyDeu5aIuvz107y9FDyU3quV_BT_4Cgob10",
      authDomain: "veltrawave-vtu.firebaseapp.com",
      projectId: "veltrawave-vtu",
      storageBucket: "veltrawave-vtu.firebasestorage.app",
      messagingSenderId: "431351611304",
      appId: "1:431351611304:web:7381dd659920f9f325a79d",
      measurementId: "G-HRHN8GJCR3"
  };
  
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  
  // Default data plans by network and type (for automatic mode)
  const DATA_PLANS = {
      "MTN": {
          "SME": [
              { id: 1, name: "500MB", price: 139, validity: "1 Month" },
              { id: 2, name: "1GB", price: 619, validity: "1 Month" },
              { id: 3, name: "2GB", price: 1229, validity: "1 Month" },
              { id: 4, name: "3GB", price: 1839, validity: "1 Month" },
              { id: 6, name: "10GB", price: 6500, validity: "1 Month" },
          ],
          "COOPERATE GIFTING": [
              { id: 50, name: "500MB", price: 139, validity: "1 Month" },
              { id: 51, name: "1GB", price: 269, validity: "1 Month" },
              { id: 52, name: "2GB", price: 529, validity: "1 Month" },
              { id: 53, name: "3GB", price: 789, validity: "1 Month" },
              { id: 54, name: "5GB", price: 1359, validity: "1 Month" },
              { id: 55, name: "10GB", price: 2669, validity: "1 Month" },
          ],
          "GIFTING": [
              { id: 101, name: "1GB", price: 419, validity: "1Day Awoof Data" },
              { id: 102, name: "1.5GB", price: 529, validity: "1Day Awoof Data" },
              { id: 103, name: "3.2GB", price: 1239, validity: "2Days Awoof Data" },
              { id: 104, name: "5GB", price: 1749, validity: "7Days Awoof Data" },
              { id: 105, name: "15GB", price: 3759, validity: "1Month Awoof Data" },
          ]
      },
      "GLO": {
          "COOPERATE GIFTING": [
              { id: 57, name: "200MB", price: 119, validity: "1 Month" },
              { id: 58, name: "500MB", price: 229, validity: "1 Month" },
              { id: 59, name: "1GB", price: 439, validity: "1 Month" },
              { id: 60, name: "2GB", price: 869, validity: "1 Month" },
              { id: 61, name: "3GB", price: 1299, validity: "1 Month" },
              { id: 62, name: "5GB", price: 2159, validity: "1 Month" },
              { id: 63, name: "10GB", price: 4400, validity: "1 Month" },
          ],
          "GIFTING": [
              { id: 90, name: "1GB", price: 239, validity: "1Day Awoof Data" },
              { id: 91, name: "2GB", price: 359, validity: "1Day Awoof Data" },
              { id: 92, name: "3.5GB", price: 559, validity: "2Days Awoof Data" },
              { id: 93, name: "15GB", price: 2359, validity: "7Days Awoof Data" },
          ]
      },
      "AIRTEL": {
          "COOPERATE GIFTING": [
              { id: 46, name: "500MB", price: 319, validity: "1 Month" },
              { id: 47, name: "1GB", price: 619, validity: "1 Month" },
              { id: 48, name: "2GB", price: 1219, validity: "1 Month" },
              { id: 49, name: "5GB", price: 319, validity: "1 Month" },
              { id: 56, name: "10GB", price: 6500, validity: "1 Month" },
              { id: 70, name: "300MB", price: 230, validity: "1Month" },
              { id: 71, name: "100MB", price: 840, validity: "1Month" },
          ],
          "GIFTING": [
              { id: 83, name: "300MB", price: 250, validity: "2Days Awoof Data" },
              { id: 84, name: "1GB", price: 360, validity: "2Days Awoof Data" },
              { id: 85, name: "2GB", price: 470, validity: "2Days Awoof Data" },
              { id: 86, name: "3GB", price: 790, validity: "7Days Awoof Data" },
              { id: 87, name: "4GB", price: 1400, validity: "1Month Awoof Data" },
              { id: 88, name: "10GB", price: 2700, validity: "1Month Awoof Data" },
              { id: 89, name: "15GB", price: 3900, validity: "1Month Awoof Data" },
          ],
          "SME": [
              { id: 94, name: "500MB", price: 260, validity: "14 Days" },
              { id: 95, name: "1GB", price: 390, validity: "7Days" },
              { id: 96, name: "1.5GB", price: 459, validity: "7 Days" },
              { id: 97, name: "2GB", price: 659, validity: "14 Days" },
              { id: 98, name: "5GB", price: 1500, validity: "14 Days" },
              { id: 100, name: "20GB", price: 4300, validity: "30 Days" },
          ]
      },
      "9MOBILE": {
          "GIFTING": [
              { id: 36, name: "1.5GB", price: 970, validity: "1 Month" },
              { id: 37, name: "2GB", price: 1300, validity: "1 Month" },
              { id: 38, name: "3GB", price: 1600, validity: "1 Month" },
              { id: 39, name: "4.5GB", price: 1950, validity: "1 Month" },
          ],
          "COOPERATE GIFTING": [
              { id: 72, name: "500MB", price: 160, validity: "1Month" },
              { id: 73, name: "1GB", price: 270, validity: "1Month" },
              { id: 74, name: "2GB", price: 490, validity: "1Month" },
              { id: 75, name: "3GB", price: 690, validity: "1Month" },
              { id: 76, name: "5GB", price: 1900, validity: "1Month" },
              { id: 77, name: "10GB", price: 2900, validity: "1Month" },
          ]
      }
  };
  
  // Initialize empty manual data plans structure (will be filled from Firebase)
  let manualDataPlans = {
      "1day": [],
      "7day": [],
      "14day": [],
      "30day": []
  };
  
  // DOM elements
  const automaticNetworkSection = document.getElementById('automaticNetworkSection');
  const networkSlider = document.getElementById('networkSlider');
  const sliderIndicators = document.getElementById('sliderIndicators');
  const networkOptions = document.querySelectorAll('.network-option');
  const selectedNetworkInput = document.getElementById('selectedNetwork');
  const planTypeSelect = document.getElementById('planType');
  const dataPlanSelect = document.getElementById('dataPlan');
  const phoneNumberInput = document.getElementById('phoneNumber');
  const submitButton = document.getElementById('submitButton');
  const buttonText = document.getElementById('buttonText');
  const dataForm = document.getElementById('dataForm');
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  const toastIcon = document.getElementById('toastIcon');
  const modalOverlay = document.getElementById('modalOverlay');
  const modalBody = document.getElementById('modalBody');
  const confirmPurchaseBtn = document.getElementById('confirmPurchase');
  const cancelPurchaseBtn = document.getElementById('cancelPurchase');
  const userBalanceElement = document.getElementById('userBalance');
  const mtnSpecialPlans = document.getElementById('mtnSpecialPlans');
  const manualDataSection = document.getElementById('manualDataSection');
  const automaticModeFields = document.getElementById('automaticModeFields');
  const manualModeFields = document.getElementById('manualModeFields');
  const selectedPlanDisplay = document.getElementById('selectedPlanDisplay');
  const selectedManualPlan = document.getElementById('selectedManualPlan');
  const requestHistoryToggle = document.getElementById('requestHistoryToggle');
  const requestList = document.getElementById('requestList');
  const requestTabs = document.querySelectorAll('.request-tab');
  const modeTabs = document.querySelectorAll('.mode-tab');
  const modeTabIndicator = document.querySelector('.mode-tab-indicator');
  const networkDisplayGroup = document.getElementById('networkDisplayGroup');
  
  // State variables
  let selectedNetwork = '';
  let selectedNetworkId = null;
  let selectedPlanType = '';
  let selectedDataPlan = null;
  let selectedManualDataPlan = null;
  let activeSlideIndex = 0;
  let isLoading = false;
  let startX, startScrollLeft;
  let isDown = false;
  let userBalance = 0;
  let currentUser = null;
  let isAutoMode = true; // Default to automatic mode
  let currentRequestTab = 'all';
  
  // Get user ID from Telegram WebApp
  function getUserId() {
      // Check if running in Telegram WebApp
      if (window.Telegram && window.Telegram.WebApp) {
          const tg = window.Telegram.WebApp;
          
          // Get user data from Telegram
          if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
              const telegramUser = tg.initDataUnsafe.user;
              const userId = telegramUser.id.toString();
              console.log("Telegram user ID detected:", userId);
              return userId;
          }
      }
      
      // Try to get from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('user_id');
      
      if (userId) {
          console.log("User ID from URL:", userId);
          return userId;
      }
      
      // If not in Telegram or URL, try localStorage
      const storedUserId = localStorage.getItem('telegram_user_id');
      if (storedUserId) {
          console.log("User ID from localStorage:", storedUserId);
          return storedUserId;
      }
      
      // If no user ID found, show error and return null
      showToast("User authentication failed. Please restart the app.", "error");
      return null;
  }
  
  // Initialize the app
  document.addEventListener('DOMContentLoaded', function() {
      // Get authenticated user ID
      const userId = getUserId();
      
      if (userId) {
          // Set current user
          currentUser = { uid: userId };
          
          // Fetch user balance
          fetchUserBalance();
          
          // Fetch manual data plans from Firestore
          fetchManualDataPlans();
          
          // Fetch user's data requests
          fetchDataRequests();
      } else {
          // Handle case where no user ID is found
          userBalanceElement.textContent = "Auth Error";
          showToast("Authentication failed. Please restart the app.", "error");
      }
      
      // Initialize slider
      initSlider();
      
      // Set up event listeners
      setupEventListeners();
      
      // Set MTN as default network
      const mtnOption = document.querySelector('.network-option.mtn');
      if (mtnOption) {
          selectNetwork('MTN', 1, mtnOption);
      }
      
      // Set automatic mode as default
      setMode('automatic');
  });
  
  // Fetch user balance from Firestore
  async function fetchUserBalance() {
      try {
          if (!currentUser || !currentUser.uid) {
              userBalanceElement.textContent = "Auth Error";
              return;
          }
          
          console.log("Fetching balance for user:", currentUser.uid);
          const userDoc = await db.collection('users').doc(currentUser.uid).get();
          
          if (userDoc.exists) {
              const userData = userDoc.data();
              userBalance = userData.balance || 0;
              userBalanceElement.textContent = formatCurrency(userBalance);
              console.log("User balance loaded:", userBalance);
          } else {
              console.error("User document not found for ID:", currentUser.uid);
              userBalanceElement.textContent = "User not found";
              showToast("User not found. Please contact support.", "error");
          }
      } catch (error) {
          console.error("Error fetching user data:", error);
          userBalanceElement.textContent = "Error";
          showToast("Error loading balance. Please refresh.", "error");
      }
  }
  
  // Fetch manual data plans from Firestore - IMPROVED VERSION
  async function fetchManualDataPlans() {
      try {
          console.log("Fetching manual data plans from Firebase...");
          
          // Clear existing manual plans
          manualDataPlans = {
              "1day": [],
              "7day": [],
              "14day": [],
              "30day": []
          };
          
          // Query the dataPlans collection for manual plans
          const plansSnapshot = await db.collection('dataPlans')
              .where('provider', '==', 'manual')
              .where('status', '==', true)
              .get();
          
          if (plansSnapshot.empty) {
              console.log("No manual data plans found in Firebase");
              showToast("No data plans found. Please contact admin.", "warning");
              return;
          }
          
          // Process each plan
          plansSnapshot.forEach(doc => {
              const plan = doc.data();
              const planId = doc.id;
              
              // Determine which category this plan belongs to
              let category;
              if (plan.category === 'manual-1day') category = '1day';
              else if (plan.category === 'manual-7day') category = '7day';
              else if (plan.category === 'manual-14day') category = '14day';
              else if (plan.category === 'manual-30day') category = '30day';
              else return; // Skip if not in a known category
              
              // Add plan to the appropriate category
              manualDataPlans[category].push({
                  id: planId,
                  data: plan.data,
                  price: plan.price,
                  originalPrice: plan.originalPrice || null,
                  validity: plan.validity,
                  badge: plan.badge || ""
              });
          });
          
          console.log("Successfully fetched manual data plans:", manualDataPlans);
          
          // Sort plans by price (lowest to highest)
          for (const category in manualDataPlans) {
              manualDataPlans[category].sort((a, b) => a.price - b.price);
          }
          
          // Render manual plans if MTN is selected and in manual mode
          if (selectedNetwork === 'MTN' && !isAutoMode) {
              renderManualDataPlans();
          }
      } catch (error) {
          console.error("Error fetching manual data plans:", error);
          showToast("Error loading data plans. Please try again later.", "error");
      }
  }
  
  // Fetch user's data requests
  async function fetchDataRequests() {
      try {
          if (!currentUser || !currentUser.uid) return;
          
          // Show loading state in the request list
          requestList.innerHTML = '<div class="loading-requests"><span class="loading"></span> Loading requests...</div>';
          
          // Check if the collection exists first
          const requestsRef = db.collection('dataRequests');
          const userRequestsQuery = requestsRef.where('userId', '==', currentUser.uid);
          
          const requestsSnapshot = await userRequestsQuery.orderBy('timestamp', 'desc').limit(20).get();
          
          const requests = [];
          
          if (requestsSnapshot.empty) {
              // No requests found
              requestList.innerHTML = '<div class="empty-requests">No requests found</div>';
          } else {
              requestsSnapshot.forEach(doc => {
                  requests.push({
                      id: doc.id,
                      ...doc.data(),
                      timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : new Date()
                  });
              });
              
              console.log("Fetched requests:", requests);
              renderDataRequests(requests);
          }
          
          // Check for pending requests
          await checkPendingRequests();
      } catch (error) {
          console.error("Error fetching data requests:", error);
          requestList.innerHTML = '<div class="empty-requests">Error loading requests. Please try again.</div>';
      }
  }
  
  // Render data requests
  function renderDataRequests(requests) {
      // Filter requests based on current tab
      const filteredRequests = currentRequestTab === 'all' 
          ? requests 
          : requests.filter(req => req.status === currentRequestTab);
      
      // Clear the request list
      requestList.innerHTML = '';
      
      if (filteredRequests.length === 0) {
          requestList.innerHTML = '<div class="empty-requests">No requests found</div>';
          return;
      }
      
      // Render each request
      filteredRequests.forEach(request => {
          const requestItem = document.createElement('div');
          requestItem.className = 'request-item';
          
          const formattedDate = request.timestamp.toLocaleString();
          const statusClass = request.status || 'pending';
          
          // Format the data and network information
          const dataInfo = request.data || request.planName || 'Unknown Plan';
          const networkInfo = request.network || 'Unknown Network';
          const phoneNumber = request.phoneNumber || 'N/A';
          const amount = formatCurrency(request.amount || 0);
          
          requestItem.innerHTML = `
              <div class="request-item-header">
                  <div class="request-date">${formattedDate}</div>
                  <div class="request-status ${statusClass}">${request.status || 'pending'}</div>
              </div>
              <div class="request-details">${dataInfo} - ${amount}</div>
              <div class="request-network">${networkInfo} - ${phoneNumber}</div>
          `;
          
          requestList.appendChild(requestItem);
      });
  }
  
  // Check for pending requests and show notification badge
  async function checkPendingRequests() {
      try {
          if (!currentUser || !currentUser.uid) return;
          
          const pendingSnapshot = await db.collection('dataRequests')
              .where('userId', '==', currentUser.uid)
              .where('status', '==', 'pending')
              .get();
          
          const pendingCount = pendingSnapshot.size;
          
          // Update the request history title with a badge if there are pending requests
          const requestHistoryTitle = document.querySelector('.request-history-title');
          const existingBadge = requestHistoryTitle.querySelector('.pending-badge');
          
          if (pendingCount > 0) {
              if (existingBadge) {
                  existingBadge.textContent = pendingCount;
              } else {
                  const badge = document.createElement('span');
                  badge.className = 'pending-badge';
                  badge.textContent = pendingCount;
                  requestHistoryTitle.appendChild(badge);
              }
          } else if (existingBadge) {
              existingBadge.remove();
          }
      } catch (error) {
          console.error("Error checking pending requests:", error);
      }
  }
  
  // Set up event listeners
  function setupEventListeners() {
      // Mode tabs functionality
      modeTabs.forEach(tab => {
          tab.addEventListener('click', function() {
              const mode = this.getAttribute('data-mode');
              setMode(mode);
          });
      });
      
      // Plan Type Select
      planTypeSelect.addEventListener('change', function() {
          selectedPlanType = this.value;
          selectedDataPlan = null;
          updateDataPlans();
          updateSubmitButtonState();
      });
      
      // Data Plan Select
      dataPlanSelect.addEventListener('change', function() {
          const planId = parseInt(this.value);
          
          if (selectedNetwork && selectedPlanType) {
              const dataPlans = DATA_PLANS[selectedNetwork][selectedPlanType] || [];
              selectedDataPlan = dataPlans.find(plan => plan.id === planId) || null;
          }
          
          updateSubmitButtonState();
      });
      
      // Phone Number Input
      phoneNumberInput.addEventListener('input', function() {
          // Allow only digits
          this.value = this.value.replace(/\D/g, '');
          updateSubmitButtonState();
      });
      
      // Data Form Submit
      dataForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          if (isAutoMode) {
              // Validate automatic mode form
              if (!selectedNetwork || !selectedPlanType || !selectedDataPlan || phoneNumberInput.value.length !== 11) {
                  showToast('Please fill in all required fields correctly', 'error');
                  return;
              }
              
              showAutomaticPurchaseModal();
          } else {
              // Validate manual mode form
              if (!selectedNetwork || !selectedManualDataPlan || phoneNumberInput.value.length !== 11) {
                  showToast('Please select a network, data plan, and enter a valid phone number', 'error');
                  return;
              }
              
              showManualPurchaseModal();
          }
      });
      
      // Confirm Purchase Button
      confirmPurchaseBtn.addEventListener('click', async function() {
          hideModal();
          
          if (isAutoMode) {
              // Handle automatic purchase
              await processAutomaticPurchase();
          } else {
              // Handle manual purchase
              await processManualPurchase();
          }
      });
      
      // Cancel Purchase Button
      cancelPurchaseBtn.addEventListener('click', function() {
          hideModal();
      });
      
      // Request History Toggle
      requestHistoryToggle.addEventListener('click', function() {
          this.classList.toggle('open');
  
          // If opening and no requests loaded yet, fetch them
          if (this.classList.contains('open') && 
              requestList.querySelector('.empty-requests') && 
              requestList.querySelector('.empty-requests').textContent === 'No requests found') {
              fetchDataRequests();
          }
      });
      
      // Request Tabs
      requestTabs.forEach(tab => {
          tab.addEventListener('click', function(e) {
              e.stopPropagation(); // Prevent toggle from closing when clicking tabs
              
              // Remove active class from all tabs
              requestTabs.forEach(t => t.classList.remove('active'));
              
              // Add active class to clicked tab
              this.classList.add('active');
              
              // Update current tab and re-render requests
              currentRequestTab = this.getAttribute('data-status');
              fetchDataRequests();
          });
      });
  }
  
  // Make sure slider is initialized after DOM is fully loaded
  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSlider);
  } else {
      initSlider();
  }
  
  // Set mode (automatic or manual)
  function setMode(mode) {
      isAutoMode = (mode === 'automatic');
      
      // Update active class on tabs
      modeTabs.forEach(tab => {
          if (tab.getAttribute('data-mode') === mode) {
              tab.classList.add('active');
          } else {
              tab.classList.remove('active');
          }
      });
      
      // Update indicator position
      if (isAutoMode) {
          modeTabIndicator.classList.remove('manual');
      } else {
          modeTabIndicator.classList.add('manual');
      }
      
      // Update UI based on selected mode
      updateModeUI();
      
      // Reset form when switching modes
      resetForm();
  }
  
  // Update UI based on selected mode
  function updateModeUI() {
      if (isAutoMode) {
          automaticNetworkSection.classList.add('show');
          manualDataSection.classList.remove('show');
          automaticModeFields.style.display = 'block';
          manualModeFields.style.display = 'none';
          
          // Show MTN special plans if MTN is selected
          if (selectedNetwork === 'MTN') {
              mtnSpecialPlans.classList.add('show');
          } else {
              mtnSpecialPlans.classList.remove('show');
          }
          
          // Set MTN as default in automatic mode
          if (!selectedNetwork) {
              const mtnOption = document.querySelector('.network-option.mtn');
              if (mtnOption) {
                  selectNetwork('MTN', 1, mtnOption);
              }
          }
      } else {
          automaticNetworkSection.classList.remove('show');
          automaticModeFields.style.display = 'none';
          manualModeFields.style.display = 'block';
          
          // Show manual data section and MTN special plans if MTN is selected
          if (selectedNetwork === 'MTN') {
              manualDataSection.classList.add('show');
              mtnSpecialPlans.classList.add('show');
              renderManualDataPlans();
          } else {
              manualDataSection.classList.remove('show');
              mtnSpecialPlans.classList.remove('show');
          }
      }

      // Show/hide network display group based on mode
      if (networkDisplayGroup) {
          networkDisplayGroup.style.display = isAutoMode ? 'block' : 'none';
      }
  }
  
  // Initialize slider
  function initSlider() {
      // Set up mouse events for desktop
      networkSlider.addEventListener('mousedown', (e) => {
          isDown = true;
          networkSlider.classList.add('active');
          startX = e.pageX - networkSlider.offsetLeft;
          startScrollLeft = networkSlider.scrollLeft;
          e.preventDefault();
      });
  
      networkSlider.addEventListener('mouseleave', () => {
          isDown = false;
          networkSlider.classList.remove('active');
      });
  
      networkSlider.addEventListener('mouseup', () => {
          isDown = false;
          networkSlider.classList.remove('active');
          snapToClosestSlide();
      });
  
      networkSlider.addEventListener('mousemove', (e) => {
          if (!isDown) return;
          e.preventDefault();
          const x = e.pageX - networkSlider.offsetLeft;
          const walk = (x - startX) * 2; // Scroll speed multiplier
          networkSlider.scrollLeft = startScrollLeft - walk;
      });
  
      // Set up touch events for mobile
      networkSlider.addEventListener('touchstart', (e) => {
          isDown = true;
          networkSlider.classList.add('active');
          startX = e.touches[0].pageX - networkSlider.offsetLeft;
          startScrollLeft = networkSlider.scrollLeft;
      }, { passive: true });
  
      networkSlider.addEventListener('touchend', () => {
          isDown = false;
          networkSlider.classList.remove('active');
          snapToClosestSlide();
      });
  
      networkSlider.addEventListener('touchmove', (e) => {
          if (!isDown) return;
          const x = e.touches[0].pageX - networkSlider.offsetLeft;
          const walk = (x - startX) * 2;
          networkSlider.scrollLeft = startScrollLeft - walk;
      }, { passive: true });
  
      // Set up scroll event to update active slide
      networkSlider.addEventListener('scroll', handleSliderScroll);
      
      // Set up indicator clicks
      const indicators = document.querySelectorAll('.indicator');
      indicators.forEach(indicator => {
          indicator.addEventListener('click', () => {
              const index = parseInt(indicator.dataset.index);
              scrollToSlide(index);
          });
      });
      
      // Set up network option clicks
      networkOptions.forEach((option, index) => {
          option.addEventListener('click', (e) => {
              const network = option.dataset.network;
              const networkId = parseInt(option.dataset.networkId);
              selectNetwork(network, networkId, option);
          });
      });
  }
  
  function snapToClosestSlide() {
      const slideWidth = networkSlider.offsetWidth;
      const slideIndex = Math.round(networkSlider.scrollLeft / slideWidth);
      scrollToSlide(slideIndex);
  }
  
  // Handle slider scroll
  function handleSliderScroll() {
      const slideWidth = networkSlider.offsetWidth;
      const newActiveSlide = Math.round(networkSlider.scrollLeft / slideWidth);
      
      if (newActiveSlide !== activeSlideIndex && newActiveSlide >= 0 && newActiveSlide < networkOptions.length) {
          activeSlideIndex = newActiveSlide;
          updateIndicators();
          
          // Select the network at the current slide
          const activeOption = networkOptions[activeSlideIndex];
          const network = activeOption.dataset.network;
          const networkId = parseInt(activeOption.dataset.networkId);
          selectNetwork(network, networkId, activeOption);
      }
  }
  
  // Update slider indicators
  function updateIndicators() {
      const indicators = document.querySelectorAll('.indicator');
      indicators.forEach((indicator, index) => {
          if (index === activeSlideIndex) {
              indicator.classList.add('active');
          } else {
              indicator.classList.remove('active');
          }
      });
  }
  
  // Scroll to specific slide
  function scrollToSlide(index) {
      if (index < 0) index = 0;
      if (index >= networkOptions.length) index = networkOptions.length - 1;
      
      const slideWidth = networkSlider.offsetWidth;
      networkSlider.scrollTo({
          left: slideWidth * index,
          behavior: 'smooth'
      });
  }
  
  // Select network
  function selectNetwork(network, networkId, element) {
      // Reset previous selection
      networkOptions.forEach(opt => opt.classList.remove('selected'));
      
      // Set new selection
      if (element) element.classList.add('selected');
      selectedNetwork = network;
      selectedNetworkId = networkId;
      selectedNetworkInput.value = network;
      
      if (isAutoMode) {
          // In automatic mode
          // Show MTN special plans if MTN is selected
          if (network === 'MTN') {
              mtnSpecialPlans.classList.add('show');
          } else {
              mtnSpecialPlans.classList.remove('show');
          }
          
          // Update plan types
          updatePlanTypes();
      } else {
          // In manual mode
          // Show manual data section if MTN is selected
          if (network === 'MTN') {
              manualDataSection.classList.add('show');
              mtnSpecialPlans.classList.add('show');
              renderManualDataPlans();
          } else {
              manualDataSection.classList.remove('show');
              mtnSpecialPlans.classList.remove('show');
          }
      }
      
      // Reset other fields
      resetForm();
      
      // Update button state
      updateSubmitButtonState();
  }
  
  // Reset form
  function resetForm() {
      selectedPlanType = '';
      selectedDataPlan = null;
      selectedManualDataPlan = null;
      planTypeSelect.value = '';
      dataPlanSelect.innerHTML = '<option value="" disabled selected>Select Data Plan</option>';
      dataPlanSelect.disabled = true;
      selectedPlanDisplay.value = '';
      updateSubmitButtonState();
  }
  
  // Update plan types based on selected network
  function updatePlanTypes() {
      // Clear existing options
      planTypeSelect.innerHTML = '<option value="" disabled selected>Select Plan Type</option>';
      
      if (selectedNetwork) {
          const planTypes = Object.keys(DATA_PLANS[selectedNetwork] || {});
          
          planTypes.forEach(type => {
              const option = document.createElement('option');
              option.value = type;
              option.textContent = type;
              planTypeSelect.appendChild(option);
          });
          
          planTypeSelect.disabled = planTypes.length === 0;
      } else {
          planTypeSelect.disabled = true;
      }
  }
  
  // Update data plans based on selected plan type
  function updateDataPlans() {
      // Clear existing options
      dataPlanSelect.innerHTML = '<option value="" disabled selected>Select Data Plan</option>';
      
      if (selectedNetwork && selectedPlanType) {
          const dataPlans = DATA_PLANS[selectedNetwork][selectedPlanType] || [];
          
          dataPlans.forEach(plan => {
              const option = document.createElement('option');
              option.value = plan.id;
              option.textContent = `${plan.name} - ${formatCurrency(plan.price)} - ${plan.validity}`;
              dataPlanSelect.appendChild(option);
          });
          
          dataPlanSelect.disabled = dataPlans.length === 0;
      } else {
          dataPlanSelect.disabled = true;
      }
  }
  
  // Format currency
  function formatCurrency(amount) {
      return new Intl.NumberFormat('en-NG', { 
          style: 'currency', 
          currency: 'NGN' 
      }).format(amount);
  }
  
  // Set loading state
  function setLoading(loading) {
      isLoading = loading;
      
      if (loading) {
          buttonText.innerHTML = '<span class="loading"></span>Processing...';
      } else {
          buttonText.innerHTML = 'Buy Now';
      }
      
      submitButton.disabled = loading;
  }
  
  // Show toast notification
  function showToast(message, type = 'success') {
      toastMessage.textContent = message;
      toast.className = 'toast';
      
      if (type === 'error') {
          toast.classList.add('error');
          toastIcon.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
              </svg>
          `;
      } else if (type === 'warning') {
          toast.classList.add('warning');
          toastIcon.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                  <line x1="12" y1="9" x2="12" y2="13"></line>
                  <line x1="12" y1="17" x2="12.01" y2="17"></line>
              </svg>
          `;
      } else {
          toast.classList.add('success');
          toastIcon.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
          `;
      }
      
      // Show toast
      toast.classList.add('show');
      
      // Hide toast after 3 seconds
      setTimeout(() => {
          toast.classList.remove('show');
      }, 3000);
  }
  
  // Show modal
  function showModal() {
      modalOverlay.classList.add('active');
  }
  
  // Hide modal
  function hideModal() {
      modalOverlay.classList.remove('active');
  }
  
  // Render manual data plans - IMPROVED VERSION
  function renderManualDataPlans() {
      console.log("Rendering manual data plans:", manualDataPlans);
      
      // Get plan container elements
      const oneDayPlans = document.getElementById('oneDayPlans');
      const sevenDayPlans = document.getElementById('sevenDayPlans');
      const fourteenDayPlans = document.getElementById('fourteenDayPlans');
      const thirtyDayPlans = document.getElementById('thirtyDayPlans');
      
      // Clear existing plans
      oneDayPlans.innerHTML = '';
      sevenDayPlans.innerHTML = '';
      fourteenDayPlans.innerHTML = '';
      thirtyDayPlans.innerHTML = '';
      
      // Check if we have plans in each category
      if (manualDataPlans['1day'].length === 0) {
          oneDayPlans.innerHTML = '<div class="empty-requests">No 1-day plans available</div>';
      } else {
          // Render 1-day plans
          manualDataPlans['1day'].forEach(plan => {
              const planCard = createPlanCard(plan);
              oneDayPlans.appendChild(planCard);
          });
      }
      
      if (manualDataPlans['7day'].length === 0) {
          sevenDayPlans.innerHTML = '<div class="empty-requests">No 7-day plans available</div>';
      } else {
          // Render 7-day plans
          manualDataPlans['7day'].forEach(plan => {
              const planCard = createPlanCard(plan);
              sevenDayPlans.appendChild(planCard);
          });
      }
      
      if (manualDataPlans['14day'].length === 0) {
          fourteenDayPlans.innerHTML = '<div class="empty-requests">No 14-day plans available</div>';
      } else {
          // Render 14-day plans
          manualDataPlans['14day'].forEach(plan => {
              const planCard = createPlanCard(plan);
              fourteenDayPlans.appendChild(planCard);
          });
      }
      
      if (manualDataPlans['30day'].length === 0) {
          thirtyDayPlans.innerHTML = '<div class="empty-requests">No 30-day plans available</div>';
      } else {
          // Render 30-day plans
          manualDataPlans['30day'].forEach(plan => {
              const planCard = createPlanCard(plan);
              thirtyDayPlans.appendChild(planCard);
          });
      }
  }
  
  // Create plan card element
  function createPlanCard(plan) {
      const planCard = document.createElement('div');
      planCard.className = 'plan-card';
      planCard.setAttribute('data-plan-id', plan.id);
      
      // Add badge if present
      if (plan.badge) {
          const badgeClass = `plan-badge ${plan.badge}`;
          const badgeText = plan.badge.charAt(0).toUpperCase() + plan.badge.slice(1);
          planCard.innerHTML += `<div class="${badgeClass}">${badgeText}</div>`;
      }
      
      // Add plan details
      planCard.innerHTML += `
          <div class="plan-data">${plan.data}</div>
          <div class="plan-validity">${plan.validity}</div>
          <div class="plan-price">
              ${plan.originalPrice ? `<span class="plan-original-price">${formatCurrency(plan.originalPrice)}</span>` : ''}
              ${formatCurrency(plan.price)}
          </div>
      `;
      
      // Add click event
      planCard.addEventListener('click', function() {
          // Remove selected class from all plan cards
          document.querySelectorAll('.plan-card').forEach(card => {
              card.classList.remove('selected');
          });
          
          // Add selected class to this card
          this.classList.add('selected');
          
          // Set selected plan
          selectedManualDataPlan = plan;
          selectedPlanDisplay.value = `${plan.data} - ${formatCurrency(plan.price)} - ${plan.validity}`;
          
          // Update submit button state
          updateSubmitButtonState();
      });
      
      return planCard;
  }
  
  // Show automatic purchase modal
  function showAutomaticPurchaseModal() {
      if (!selectedDataPlan) return;
      
      modalBody.innerHTML = `
          <div class="warning-message">
              <i class="fas fa-exclamation-triangle"></i>
              Please confirm your purchase details
          </div>
          <div class="summary-row">
              <div class="summary-label">Network:</div>
              <div class="summary-value">${selectedNetwork}</div>
          </div>
          <div class="summary-row">
              <div class="summary-label">Plan Type:</div>
              <div class="summary-value">${selectedPlanType}</div>
          </div>
          <div class="summary-row">
              <div class="summary-label">Data Plan:</div>
              <div class="summary-value">${selectedDataPlan.name} (${selectedDataPlan.validity})</div>
          </div>
          <div class="summary-row">
              <div class="summary-label">Phone Number:</div>
              <div class="summary-value">${phoneNumberInput.value}</div>
          </div>
          <div class="summary-row">
              <div class="summary-label">Amount:</div>
              <div class="summary-value">${formatCurrency(selectedDataPlan.price)}</div>
          </div>
      `;
      
      showModal();
  }
  
  // Show manual purchase modal
  function showManualPurchaseModal() {
      if (!selectedManualDataPlan) return;
      
      modalBody.innerHTML = `
          <div class="warning-message">
              <i class="fas fa-exclamation-triangle"></i>
              Please confirm your purchase details
          </div>
          <div class="summary-row">
              <div class="summary-label">Network:</div>
              <div class="summary-value">${selectedNetwork}</div>
          </div>
          <div class="summary-row">
              <div class="summary-label">Data Plan:</div>
              <div class="summary-value">${selectedManualDataPlan.data} (${selectedManualDataPlan.validity})</div>
          </div>
          <div class="summary-row">
              <div class="summary-label">Phone Number:</div>
              <div class="summary-value">${phoneNumberInput.value}</div>
          </div>
          <div class="summary-row">
              <div class="summary-label">Amount:</div>
              <div class="summary-value">${formatCurrency(selectedManualDataPlan.price)}</div>
          </div>
      `;
      
      showModal();
  }

  // Update submit button state
  function updateSubmitButtonState() {
      if (isAutoMode) {
          // In automatic mode
          submitButton.disabled = !selectedNetwork || !selectedPlanType || !selectedDataPlan || phoneNumberInput.value.length !== 11 || isLoading;
      } else {
          // In manual mode - only need plan and phone number
          submitButton.disabled = !selectedManualDataPlan || phoneNumberInput.value.length !== 11 || isLoading;
      }
  }

  // Process automatic purchase
  async function processAutomaticPurchase() {
      try {
          setLoading(true);
          
          // Check if user has enough balance
          if (userBalance < selectedDataPlan.price) {
              showToast('VeltraWave error contact admin', 'error');
              setLoading(false);
              return;
          }
          
          // Generate a unique request ID
          const requestId = `Data_${Date.now()}${Math.floor(Math.random() * 1000)}`;
          
          // Prepare the request payload
          const payload = {
              network: selectedNetworkId,
              phone: phoneNumberInput.value,
              data_plan: selectedDataPlan.id,
              bypass: false,
              "request-id": requestId
          };
          
          console.log("Sending API request payload:", payload);
          
          // Make the API call
          const response = await fetch('https://n3tdata.com/api/data', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Token ${ACCESS_TOKEN}`
              },
              body: JSON.stringify(payload)
          });
          
          const responseData = await response.json();
          console.log("API Response:", responseData);
          
          if (responseData.status === 'success') {
              // Create request in Firestore
              const requestData = {
                  userId: currentUser.uid,
                  network: selectedNetwork,
                  networkId: selectedNetworkId,
                  planType: selectedPlanType,
                  planId: selectedDataPlan.id,
                  planName: selectedDataPlan.name,
                  amount: selectedDataPlan.price,
                  phoneNumber: phoneNumberInput.value,
                  status: 'completed',
                  apiResponse: responseData,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              const requestRef = await db.collection('dataRequests').add(requestData);
              
              // Deduct balance from user's wallet
              await db.collection('users').doc(currentUser.uid).update({
                  balance: firebase.firestore.FieldValue.increment(-selectedDataPlan.price)
              });
              
              // Refresh user balance
              await fetchUserBalance();
              
              // Show success message
              showToast(`${selectedDataPlan.name} data bundle has been purchased for ${phoneNumberInput.value}`, 'success');
              
              // Refresh data requests
              await fetchDataRequests();
              
              // Reset form
              phoneNumberInput.value = '';
              resetForm();
          } else {
              // Handle API error
              showToast(responseData.message || 'VeltraWave error contact admin', 'error');
              
              // Create failed request in Firestore
              const requestData = {
                  userId: currentUser.uid,
                  network: selectedNetwork,
                  networkId: selectedNetworkId,
                  planType: selectedPlanType,
                  planId: selectedDataPlan.id,
                  planName: selectedDataPlan.name,
                  amount: selectedDataPlan.price,
                  phoneNumber: phoneNumberInput.value,
                  status: 'rejected',
                  apiResponse: responseData,
                  timestamp: firebase.firestore.FieldValue.serverTimestamp()
              };
              
              await db.collection('dataRequests').add(requestData);
          }
      } catch (error) {
          console.error("Error processing purchase:", error);
          showToast('VeltraWave error contact admin', 'error');
      } finally {
          setLoading(false);
      }
  }
  
  // Process manual purchase
  async function processManualPurchase() {
      try {
          setLoading(true);
          
          // Check if user has enough balance
          if (userBalance < selectedManualDataPlan.price) {
              showToast('VeltraWave error contact admin', 'error');
              setLoading(false);
              return;
          }
          
          // Create request in Firestore
          const requestData = {
              userId: currentUser.uid,
              network: selectedNetwork,
              networkId: selectedNetworkId,
              planType: 'manual',
              planId: selectedManualDataPlan.id,
              planName: selectedManualDataPlan.data,
              amount: selectedManualDataPlan.price,
              phoneNumber: phoneNumberInput.value,
              status: 'pending',
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          const requestRef = await db.collection('dataRequests').add(requestData);
          
          // Deduct balance from user's wallet
          await db.collection('users').doc(currentUser.uid).update({
              balance: firebase.firestore.FieldValue.increment(-selectedManualDataPlan.price)
          });
          
          // Refresh user balance
          await fetchUserBalance();
          
          // Show success message
          showToast('Data purchase request submitted successfully!', 'success');
          
          // Refresh data requests
          await fetchDataRequests();
          
          // Reset form
          phoneNumberInput.value = '';
          resetForm();
      } catch (error) {
          console.error("Error processing purchase:", error);
          showToast('VeltraWave error contact admin', 'error');
      } finally {
          setLoading(false);
      }
  }
</script>
</body>
</html>
